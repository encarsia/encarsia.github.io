<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="description" content="nibook.py">
<meta name="viewport" content="width=device-width">
<title>nibook.py | Merge and Destroy</title>
<link href="//fonts.googleapis.com/css?family=Bitter:400,400i,700" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.0.11/css/fork-awesome.min.css" integrity="sha256-MGU/JUq/40CFrfxjXb5pZjpoZmxiP2KuICN5ElLFNd8=" crossorigin="anonymous">
<link href="../assets/css/all.css" rel="stylesheet" type="text/css">
<link rel="alternate" type="application/rss+xml" title="RSS (de)" href="../rss.xml">
<link rel="alternate" type="application/rss+xml" title="RSS (en)" href="../en/rss.xml">
<link rel="canonical" href="https://encarsia.github.io/listings/nibook.py.html">
<!--[if lt IE 9]><script src="/assets/js/html5.js"></script><![endif]-->
</head>
<body>
    <section class="social"><ul>
<li><a href="../index.html" title="Home"><i class="fa fa-home"></i></a></li>
            <li><a href="../posts/tutorial-reihe-glade/index.html" title="Tutorials"><i class="fa fa-lightbulb-o"></i></a></li>
            <li><a href="https://octodon.social/@encarsia" title="Mastodon"><i class="fa fa-mastodon"></i></a></li>
            <li><a href="https://twitter.com/encarsia_" title="Twitter"><i class="fa fa-twitter"></i></a></li>
            <li><a href="https://plus.google.com/105146352752269764996/posts" title="Google+"><i class="fa fa-google-plus-official"></i></a></li>
            <li><a href="https://github.com/encarsia" title="Github"><i class="fa fa-github"></i></a></li>
            <li><a href="../categories/index.html" title="Tags"><i class="fa fa-tags"></i></a></li>
            <li><a href="../rss.xml" title="RSS"><i class="fa fa-rss"></i></a></li>
            <li><a href="../pages/about/index.html" title="About me"><i class="fa fa-user"></i></a></li>
            <li><a href="../archive.html" title="Archives"><i class="fa fa-folder-open"></i></a></li>

        </ul></section><section class="page-content"><div class="content" rel="main">
            

<nav class="breadcrumbs"><ul class="breadcrumb">
<li><a href=".">listings</a></li>
                <li>nibook.py</li>
</ul></nav><h1>nibook.py
            <small><a href="nibook.py">(Source)</a></small>
        </h1>
    <table class="codetable"><tr>
<td class="linenos"><div class="linenodiv"><pre><a href="#listingsnibookpy-1">  1</a>
<a href="#listingsnibookpy-2">  2</a>
<a href="#listingsnibookpy-3">  3</a>
<a href="#listingsnibookpy-4">  4</a>
<a href="#listingsnibookpy-5">  5</a>
<a href="#listingsnibookpy-6">  6</a>
<a href="#listingsnibookpy-7">  7</a>
<a href="#listingsnibookpy-8">  8</a>
<a href="#listingsnibookpy-9">  9</a>
<a href="#listingsnibookpy-10"> 10</a>
<a href="#listingsnibookpy-11"> 11</a>
<a href="#listingsnibookpy-12"> 12</a>
<a href="#listingsnibookpy-13"> 13</a>
<a href="#listingsnibookpy-14"> 14</a>
<a href="#listingsnibookpy-15"> 15</a>
<a href="#listingsnibookpy-16"> 16</a>
<a href="#listingsnibookpy-17"> 17</a>
<a href="#listingsnibookpy-18"> 18</a>
<a href="#listingsnibookpy-19"> 19</a>
<a href="#listingsnibookpy-20"> 20</a>
<a href="#listingsnibookpy-21"> 21</a>
<a href="#listingsnibookpy-22"> 22</a>
<a href="#listingsnibookpy-23"> 23</a>
<a href="#listingsnibookpy-24"> 24</a>
<a href="#listingsnibookpy-25"> 25</a>
<a href="#listingsnibookpy-26"> 26</a>
<a href="#listingsnibookpy-27"> 27</a>
<a href="#listingsnibookpy-28"> 28</a>
<a href="#listingsnibookpy-29"> 29</a>
<a href="#listingsnibookpy-30"> 30</a>
<a href="#listingsnibookpy-31"> 31</a>
<a href="#listingsnibookpy-32"> 32</a>
<a href="#listingsnibookpy-33"> 33</a>
<a href="#listingsnibookpy-34"> 34</a>
<a href="#listingsnibookpy-35"> 35</a>
<a href="#listingsnibookpy-36"> 36</a>
<a href="#listingsnibookpy-37"> 37</a>
<a href="#listingsnibookpy-38"> 38</a>
<a href="#listingsnibookpy-39"> 39</a>
<a href="#listingsnibookpy-40"> 40</a>
<a href="#listingsnibookpy-41"> 41</a>
<a href="#listingsnibookpy-42"> 42</a>
<a href="#listingsnibookpy-43"> 43</a>
<a href="#listingsnibookpy-44"> 44</a>
<a href="#listingsnibookpy-45"> 45</a>
<a href="#listingsnibookpy-46"> 46</a>
<a href="#listingsnibookpy-47"> 47</a>
<a href="#listingsnibookpy-48"> 48</a>
<a href="#listingsnibookpy-49"> 49</a>
<a href="#listingsnibookpy-50"> 50</a>
<a href="#listingsnibookpy-51"> 51</a>
<a href="#listingsnibookpy-52"> 52</a>
<a href="#listingsnibookpy-53"> 53</a>
<a href="#listingsnibookpy-54"> 54</a>
<a href="#listingsnibookpy-55"> 55</a>
<a href="#listingsnibookpy-56"> 56</a>
<a href="#listingsnibookpy-57"> 57</a>
<a href="#listingsnibookpy-58"> 58</a>
<a href="#listingsnibookpy-59"> 59</a>
<a href="#listingsnibookpy-60"> 60</a>
<a href="#listingsnibookpy-61"> 61</a>
<a href="#listingsnibookpy-62"> 62</a>
<a href="#listingsnibookpy-63"> 63</a>
<a href="#listingsnibookpy-64"> 64</a>
<a href="#listingsnibookpy-65"> 65</a>
<a href="#listingsnibookpy-66"> 66</a>
<a href="#listingsnibookpy-67"> 67</a>
<a href="#listingsnibookpy-68"> 68</a>
<a href="#listingsnibookpy-69"> 69</a>
<a href="#listingsnibookpy-70"> 70</a>
<a href="#listingsnibookpy-71"> 71</a>
<a href="#listingsnibookpy-72"> 72</a>
<a href="#listingsnibookpy-73"> 73</a>
<a href="#listingsnibookpy-74"> 74</a>
<a href="#listingsnibookpy-75"> 75</a>
<a href="#listingsnibookpy-76"> 76</a>
<a href="#listingsnibookpy-77"> 77</a>
<a href="#listingsnibookpy-78"> 78</a>
<a href="#listingsnibookpy-79"> 79</a>
<a href="#listingsnibookpy-80"> 80</a>
<a href="#listingsnibookpy-81"> 81</a>
<a href="#listingsnibookpy-82"> 82</a>
<a href="#listingsnibookpy-83"> 83</a>
<a href="#listingsnibookpy-84"> 84</a>
<a href="#listingsnibookpy-85"> 85</a>
<a href="#listingsnibookpy-86"> 86</a>
<a href="#listingsnibookpy-87"> 87</a>
<a href="#listingsnibookpy-88"> 88</a>
<a href="#listingsnibookpy-89"> 89</a>
<a href="#listingsnibookpy-90"> 90</a>
<a href="#listingsnibookpy-91"> 91</a>
<a href="#listingsnibookpy-92"> 92</a>
<a href="#listingsnibookpy-93"> 93</a>
<a href="#listingsnibookpy-94"> 94</a>
<a href="#listingsnibookpy-95"> 95</a>
<a href="#listingsnibookpy-96"> 96</a>
<a href="#listingsnibookpy-97"> 97</a>
<a href="#listingsnibookpy-98"> 98</a>
<a href="#listingsnibookpy-99"> 99</a>
<a href="#listingsnibookpy-100">100</a>
<a href="#listingsnibookpy-101">101</a>
<a href="#listingsnibookpy-102">102</a>
<a href="#listingsnibookpy-103">103</a>
<a href="#listingsnibookpy-104">104</a>
<a href="#listingsnibookpy-105">105</a>
<a href="#listingsnibookpy-106">106</a>
<a href="#listingsnibookpy-107">107</a>
<a href="#listingsnibookpy-108">108</a>
<a href="#listingsnibookpy-109">109</a>
<a href="#listingsnibookpy-110">110</a>
<a href="#listingsnibookpy-111">111</a>
<a href="#listingsnibookpy-112">112</a>
<a href="#listingsnibookpy-113">113</a>
<a href="#listingsnibookpy-114">114</a>
<a href="#listingsnibookpy-115">115</a>
<a href="#listingsnibookpy-116">116</a>
<a href="#listingsnibookpy-117">117</a>
<a href="#listingsnibookpy-118">118</a>
<a href="#listingsnibookpy-119">119</a>
<a href="#listingsnibookpy-120">120</a>
<a href="#listingsnibookpy-121">121</a>
<a href="#listingsnibookpy-122">122</a>
<a href="#listingsnibookpy-123">123</a>
<a href="#listingsnibookpy-124">124</a>
<a href="#listingsnibookpy-125">125</a>
<a href="#listingsnibookpy-126">126</a>
<a href="#listingsnibookpy-127">127</a>
<a href="#listingsnibookpy-128">128</a>
<a href="#listingsnibookpy-129">129</a>
<a href="#listingsnibookpy-130">130</a>
<a href="#listingsnibookpy-131">131</a>
<a href="#listingsnibookpy-132">132</a>
<a href="#listingsnibookpy-133">133</a>
<a href="#listingsnibookpy-134">134</a>
<a href="#listingsnibookpy-135">135</a>
<a href="#listingsnibookpy-136">136</a>
<a href="#listingsnibookpy-137">137</a>
<a href="#listingsnibookpy-138">138</a>
<a href="#listingsnibookpy-139">139</a>
<a href="#listingsnibookpy-140">140</a>
<a href="#listingsnibookpy-141">141</a>
<a href="#listingsnibookpy-142">142</a>
<a href="#listingsnibookpy-143">143</a>
<a href="#listingsnibookpy-144">144</a>
<a href="#listingsnibookpy-145">145</a>
<a href="#listingsnibookpy-146">146</a>
<a href="#listingsnibookpy-147">147</a>
<a href="#listingsnibookpy-148">148</a>
<a href="#listingsnibookpy-149">149</a>
<a href="#listingsnibookpy-150">150</a>
<a href="#listingsnibookpy-151">151</a>
<a href="#listingsnibookpy-152">152</a>
<a href="#listingsnibookpy-153">153</a>
<a href="#listingsnibookpy-154">154</a>
<a href="#listingsnibookpy-155">155</a>
<a href="#listingsnibookpy-156">156</a>
<a href="#listingsnibookpy-157">157</a>
<a href="#listingsnibookpy-158">158</a>
<a href="#listingsnibookpy-159">159</a>
<a href="#listingsnibookpy-160">160</a>
<a href="#listingsnibookpy-161">161</a>
<a href="#listingsnibookpy-162">162</a>
<a href="#listingsnibookpy-163">163</a>
<a href="#listingsnibookpy-164">164</a>
<a href="#listingsnibookpy-165">165</a>
<a href="#listingsnibookpy-166">166</a>
<a href="#listingsnibookpy-167">167</a>
<a href="#listingsnibookpy-168">168</a>
<a href="#listingsnibookpy-169">169</a>
<a href="#listingsnibookpy-170">170</a>
<a href="#listingsnibookpy-171">171</a>
<a href="#listingsnibookpy-172">172</a>
<a href="#listingsnibookpy-173">173</a>
<a href="#listingsnibookpy-174">174</a>
<a href="#listingsnibookpy-175">175</a>
<a href="#listingsnibookpy-176">176</a>
<a href="#listingsnibookpy-177">177</a>
<a href="#listingsnibookpy-178">178</a>
<a href="#listingsnibookpy-179">179</a>
<a href="#listingsnibookpy-180">180</a>
<a href="#listingsnibookpy-181">181</a>
<a href="#listingsnibookpy-182">182</a>
<a href="#listingsnibookpy-183">183</a>
<a href="#listingsnibookpy-184">184</a>
<a href="#listingsnibookpy-185">185</a>
<a href="#listingsnibookpy-186">186</a>
<a href="#listingsnibookpy-187">187</a>
<a href="#listingsnibookpy-188">188</a>
<a href="#listingsnibookpy-189">189</a>
<a href="#listingsnibookpy-190">190</a>
<a href="#listingsnibookpy-191">191</a>
<a href="#listingsnibookpy-192">192</a>
<a href="#listingsnibookpy-193">193</a></pre></div></td>
<td class="code"><pre class="code literal-block"><a name="listingsnibookpy-1"></a><span class="ch">#!/usr/bin/python</span>
<a name="listingsnibookpy-2"></a><span class="c1"># -*- coding: utf-8 -*-</span>
<a name="listingsnibookpy-3"></a>
<a name="listingsnibookpy-4"></a><span class="kn">import</span> <span class="nn">glob</span>
<a name="listingsnibookpy-5"></a><span class="kn">import</span> <span class="nn">os</span>
<a name="listingsnibookpy-6"></a><span class="kn">import</span> <span class="nn">shutil</span>
<a name="listingsnibookpy-7"></a><span class="kn">import</span> <span class="nn">subprocess</span>
<a name="listingsnibookpy-8"></a>
<a name="listingsnibookpy-9"></a><span class="n">GHP</span> <span class="o">=</span> <span class="s2">"/home/anke/Web/GitHubPage_encarsia"</span>
<a name="listingsnibookpy-10"></a><span class="n">DL_DIR</span> <span class="o">=</span> <span class="s2">"/files/tut_ebook"</span>
<a name="listingsnibookpy-11"></a><span class="n">POSTS</span> <span class="o">=</span> <span class="p">[]</span>
<a name="listingsnibookpy-12"></a><span class="n">SPHDIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
<a name="listingsnibookpy-13"></a><span class="n">META</span> <span class="o">=</span> <span class="s1">'''.. meta::</span>
<a name="listingsnibookpy-14"></a><span class="s1">   :http-equiv=Content-Type: text/html; charset=UTF-8</span>
<a name="listingsnibookpy-15"></a>
<a name="listingsnibookpy-16"></a><span class="s1">'''</span>
<a name="listingsnibookpy-17"></a>
<a name="listingsnibookpy-18"></a><span class="k">def</span> <span class="nf">collect_posts</span><span class="p">():</span>
<a name="listingsnibookpy-19"></a>    <span class="c1"># get posts</span>
<a name="listingsnibookpy-20"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">"index.lst"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a name="listingsnibookpy-21"></a>        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
<a name="listingsnibookpy-22"></a>    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
<a name="listingsnibookpy-23"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span> <span class="o">==</span> <span class="s2">""</span><span class="p">:</span>
<a name="listingsnibookpy-24"></a>            <span class="n">POSTS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span> <span class="o">+</span> <span class="s2">".rst"</span><span class="p">)</span>
<a name="listingsnibookpy-25"></a>    <span class="k">print</span><span class="p">(</span><span class="s2">"Posts collected..."</span><span class="p">)</span>
<a name="listingsnibookpy-26"></a>    
<a name="listingsnibookpy-27"></a><span class="k">def</span> <span class="nf">copy_posts</span><span class="p">():</span>
<a name="listingsnibookpy-28"></a>    <span class="c1"># copy posts into /posts folder</span>
<a name="listingsnibookpy-29"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">SPHDIR</span> <span class="o">+</span> <span class="s2">"/posts"</span><span class="p">):</span>
<a name="listingsnibookpy-30"></a>        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">SPHDIR</span> <span class="o">+</span> <span class="s2">"/posts"</span><span class="p">)</span>
<a name="listingsnibookpy-31"></a>    <span class="k">for</span> <span class="n">post</span> <span class="ow">in</span> <span class="n">POSTS</span><span class="p">:</span>
<a name="listingsnibookpy-32"></a>        <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GHP</span><span class="p">,</span> <span class="s2">"posts"</span><span class="p">,</span> <span class="n">post</span><span class="p">),</span> <span class="s2">"posts"</span><span class="p">)</span>
<a name="listingsnibookpy-33"></a>    <span class="k">print</span><span class="p">(</span><span class="s2">"Posts copied to Sphinx folder..."</span><span class="p">)</span>
<a name="listingsnibookpy-34"></a>
<a name="listingsnibookpy-35"></a><span class="k">def</span> <span class="nf">create_index</span><span class="p">():</span>
<a name="listingsnibookpy-36"></a>    <span class="c1"># insert post filenames to index template and save as index.rst</span>
<a name="listingsnibookpy-37"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">"index.tmpl"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a name="listingsnibookpy-38"></a>        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
<a name="listingsnibookpy-39"></a>    <span class="n">pos</span> <span class="o">=</span><span class="n">lines</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">"    .. include-start</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
<a name="listingsnibookpy-40"></a>    <span class="k">del</span> <span class="n">lines</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
<a name="listingsnibookpy-41"></a>    <span class="k">for</span> <span class="n">post</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">POSTS</span><span class="p">):</span>
<a name="listingsnibookpy-42"></a>        <span class="n">lines</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="s2">"    posts/{}</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">post</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]))</span>
<a name="listingsnibookpy-43"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">"index.rst"</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a name="listingsnibookpy-44"></a>        <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
<a name="listingsnibookpy-45"></a>    <span class="p">(</span><span class="s2">"Index.rst generated from template..."</span><span class="p">)</span>
<a name="listingsnibookpy-46"></a>
<a name="listingsnibookpy-47"></a><span class="k">def</span> <span class="nf">sph_title</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
<a name="listingsnibookpy-48"></a>    <span class="c1"># convert title comment to chapter, position is always line 1</span>
<a name="listingsnibookpy-49"></a>    <span class="c1"># convert Nikola slugs into internal reference, position is always</span>
<a name="listingsnibookpy-50"></a>    <span class="c1"># line 2 but title function inserts 3</span>
<a name="listingsnibookpy-51"></a>    <span class="c1"># insert meta tag for correct encoding when running kindlegen</span>
<a name="listingsnibookpy-52"></a>    <span class="n">title</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">10</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<a name="listingsnibookpy-53"></a>    <span class="n">src</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s2">"{}</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">title</span><span class="p">))</span>
<a name="listingsnibookpy-54"></a>    <span class="n">src</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s2">"{}</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"*"</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">title</span><span class="p">)))</span>
<a name="listingsnibookpy-55"></a>    <span class="n">src</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s2">"{}</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"*"</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">title</span><span class="p">)))</span>
<a name="listingsnibookpy-56"></a>    <span class="n">slug</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>
<a name="listingsnibookpy-57"></a>    <span class="n">ref</span> <span class="o">=</span> <span class="s2">".. _{}:</span><span class="se">\n\n</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">slug</span><span class="p">)</span>
<a name="listingsnibookpy-58"></a>    <span class="n">src</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ref</span><span class="p">)</span>
<a name="listingsnibookpy-59"></a>    <span class="n">src</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">META</span><span class="p">)</span>
<a name="listingsnibookpy-60"></a>
<a name="listingsnibookpy-61"></a><span class="k">def</span> <span class="nf">sph_edit</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">del_lines</span><span class="p">):</span>
<a name="listingsnibookpy-62"></a>    <span class="c1"># delete unwanted content like table of contents</span>
<a name="listingsnibookpy-63"></a>    <span class="c1"># convert custom Nikola directives thumbnail and listing to image</span>
<a name="listingsnibookpy-64"></a>    <span class="c1"># and literalinclude</span>
<a name="listingsnibookpy-65"></a>    <span class="c1"># use original files and images with Sphinx, demands relative paths</span>
<a name="listingsnibookpy-66"></a>    <span class="c1"># ignore GIF images</span>
<a name="listingsnibookpy-67"></a>    <span class="c1"># delete custom G+ link, this won't work if you use the raw</span>
<a name="listingsnibookpy-68"></a>    <span class="c1"># directive in any other way</span>
<a name="listingsnibookpy-69"></a>    <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
<a name="listingsnibookpy-70"></a>        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">del_lines</span><span class="p">):</span>
<a name="listingsnibookpy-71"></a>            <span class="k">del</span> <span class="n">src</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
<a name="listingsnibookpy-72"></a>        <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">".. thumbnail::"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">".. image::"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">".. figure::"</span><span class="p">):</span>
<a name="listingsnibookpy-73"></a>            <span class="k">del</span> <span class="n">src</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
<a name="listingsnibookpy-74"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">".gif</span><span class="se">\n</span><span class="s2">"</span><span class="p">):</span>
<a name="listingsnibookpy-75"></a>                <span class="n">new_line</span> <span class="o">=</span> <span class="s2">".. figure:: ../{}{}</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">GHP</span><span class="p">),</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">])</span>
<a name="listingsnibookpy-76"></a>                <span class="n">src</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">new_line</span><span class="p">)</span>
<a name="listingsnibookpy-77"></a>        <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">".. listing::"</span><span class="p">):</span>
<a name="listingsnibookpy-78"></a>            <span class="k">del</span> <span class="n">src</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
<a name="listingsnibookpy-79"></a>            <span class="n">filename</span><span class="p">,</span> <span class="n">lang</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">],</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">3</span><span class="p">]</span>
<a name="listingsnibookpy-80"></a>            <span class="n">new_line</span> <span class="o">=</span> <span class="s2">".. literalinclude:: ../{}/listings/{}</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">GHP</span><span class="p">),</span> <span class="n">filename</span><span class="p">)</span>
<a name="listingsnibookpy-81"></a>            <span class="n">src</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">new_line</span><span class="p">)</span>
<a name="listingsnibookpy-82"></a>            <span class="n">new_line</span> <span class="o">=</span> <span class="s2">"    :language: {}</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lang</span><span class="p">)</span>
<a name="listingsnibookpy-83"></a>            <span class="n">src</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">new_line</span><span class="p">)</span>
<a name="listingsnibookpy-84"></a>        <span class="c1">### !!! Delete the following if statement if you use the raw directive !!!</span>
<a name="listingsnibookpy-85"></a>        <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">".. raw:: html"</span><span class="p">):</span>
<a name="listingsnibookpy-86"></a>            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
<a name="listingsnibookpy-87"></a>                <span class="k">del</span> <span class="n">src</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
<a name="listingsnibookpy-88"></a>
<a name="listingsnibookpy-89"></a><span class="k">def</span> <span class="nf">sph_deslug</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
<a name="listingsnibookpy-90"></a>    <span class="sd">"""convert internal links using slug into working internal link</span>
<a name="listingsnibookpy-91"></a><span class="sd">        Example:    in:  `description &lt;link://slug/thisisit&gt;`_</span>
<a name="listingsnibookpy-92"></a><span class="sd">                    out: `description &lt;filenameofslugorigin.xhtml#thisisit&gt;`_</span>
<a name="listingsnibookpy-93"></a><span class="sd">            </span>
<a name="listingsnibookpy-94"></a><span class="sd">            normally slug == filename but sometimes things aren't normal</span>
<a name="listingsnibookpy-95"></a><span class="sd">            this example only works with epub builder, links are broken with LaTeX builder</span>
<a name="listingsnibookpy-96"></a><span class="sd">            </span>
<a name="listingsnibookpy-97"></a><span class="sd">            probably the easiest way is to format links to</span>
<a name="listingsnibookpy-98"></a><span class="sd">                    out: description (:ref:`thisisit`)</span>
<a name="listingsnibookpy-99"></a><span class="sd">            because the references have already been set in sph_title function</span>
<a name="listingsnibookpy-100"></a><span class="sd">            the only (cosmetic) issue is the link text being separated from the link</span>
<a name="listingsnibookpy-101"></a><span class="sd">            </span>
<a name="listingsnibookpy-102"></a><span class="sd">            that'll do</span>
<a name="listingsnibookpy-103"></a><span class="sd">            </span>
<a name="listingsnibookpy-104"></a><span class="sd">        Explanation of string splits:</span>
<a name="listingsnibookpy-105"></a><span class="sd">                    </span>
<a name="listingsnibookpy-106"></a><span class="sd">                    Sentence with a `slugified link &lt;link://slug/thisisit&gt;`_.</span>
<a name="listingsnibookpy-107"></a><span class="sd">            1)'&gt;`_' [0]                                                  |  |[1] post</span>
<a name="listingsnibookpy-108"></a><span class="sd">            2)' &lt;'  [0]                            ||[1]                 |-----------</span>
<a name="listingsnibookpy-109"></a><span class="sd">            3)'`'   [0] pre        ||[1] descr      |--------------------|-----------</span>
<a name="listingsnibookpy-110"></a><span class="sd">            4)'/'   -------------------------------||[0]  ||[2] |[3] ref |-----------</span>
<a name="listingsnibookpy-111"></a><span class="sd">    """</span>
<a name="listingsnibookpy-112"></a>    <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
<a name="listingsnibookpy-113"></a>        <span class="k">while</span> <span class="s2">"&lt;link://slug/"</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
<a name="listingsnibookpy-114"></a>            <span class="n">split1</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"&gt;`_"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>   <span class="c1"># always process first link</span>
<a name="listingsnibookpy-115"></a>            <span class="n">split2</span> <span class="o">=</span> <span class="n">split1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">" &lt;"</span><span class="p">)</span>
<a name="listingsnibookpy-116"></a>            <span class="n">split3</span> <span class="o">=</span> <span class="n">split2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"`"</span><span class="p">)</span>
<a name="listingsnibookpy-117"></a>            <span class="n">split4</span> <span class="o">=</span> <span class="n">split2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)</span>
<a name="listingsnibookpy-118"></a>            <span class="n">pre</span> <span class="o">=</span> <span class="n">split3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a name="listingsnibookpy-119"></a>            <span class="n">descr</span> <span class="o">=</span> <span class="n">split3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a name="listingsnibookpy-120"></a>            <span class="n">ref</span> <span class="o">=</span> <span class="n">split4</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<a name="listingsnibookpy-121"></a>            <span class="n">post</span> <span class="o">=</span> <span class="n">split1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a name="listingsnibookpy-122"></a>            <span class="n">line</span> <span class="o">=</span> <span class="s2">"{} {} (:ref:`{}`){}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pre</span><span class="p">,</span> <span class="n">descr</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">post</span><span class="p">)</span>
<a name="listingsnibookpy-123"></a>            <span class="k">del</span> <span class="n">src</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
<a name="listingsnibookpy-124"></a>            <span class="n">src</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
<a name="listingsnibookpy-125"></a>
<a name="listingsnibookpy-126"></a><span class="k">def</span> <span class="nf">prepare_sources</span><span class="p">():</span>
<a name="listingsnibookpy-127"></a>    <span class="c1"># #########   prepare rst source files for Sphinx  ###########</span>
<a name="listingsnibookpy-128"></a>    <span class="k">for</span> <span class="n">post</span> <span class="ow">in</span> <span class="n">POSTS</span><span class="p">:</span>
<a name="listingsnibookpy-129"></a>        <span class="c1"># read source file into string variable</span>
<a name="listingsnibookpy-130"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">"posts/"</span> <span class="o">+</span> <span class="n">post</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a name="listingsnibookpy-131"></a>            <span class="n">nikola_source</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
<a name="listingsnibookpy-132"></a>
<a name="listingsnibookpy-133"></a>        <span class="n">sph_title</span><span class="p">(</span><span class="n">nikola_source</span><span class="p">)</span>
<a name="listingsnibookpy-134"></a>        
<a name="listingsnibookpy-135"></a>        <span class="c1"># tuple of strings to select for deletion</span>
<a name="listingsnibookpy-136"></a>        <span class="n">del_lines</span> <span class="o">=</span> <span class="p">(</span><span class="s2">".. class::"</span><span class="p">,</span>
<a name="listingsnibookpy-137"></a>                     <span class="s2">".. contents::"</span><span class="p">,</span>
<a name="listingsnibookpy-138"></a>                    <span class="p">)</span>
<a name="listingsnibookpy-139"></a>        <span class="n">sph_edit</span><span class="p">(</span><span class="n">nikola_source</span><span class="p">,</span> <span class="n">del_lines</span><span class="p">)</span>
<a name="listingsnibookpy-140"></a>        <span class="n">sph_deslug</span><span class="p">(</span><span class="n">nikola_source</span><span class="p">)</span>
<a name="listingsnibookpy-141"></a>
<a name="listingsnibookpy-142"></a>        <span class="c1"># write edited source code into file </span>
<a name="listingsnibookpy-143"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">"posts/"</span> <span class="o">+</span> <span class="n">post</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a name="listingsnibookpy-144"></a>            <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">nikola_source</span><span class="p">)</span>
<a name="listingsnibookpy-145"></a>        <span class="k">print</span><span class="p">(</span><span class="s2">"File ({}) prepared..."</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">post</span><span class="p">))</span>
<a name="listingsnibookpy-146"></a>
<a name="listingsnibookpy-147"></a><span class="k">def</span> <span class="nf">menu</span><span class="p">():</span>
<a name="listingsnibookpy-148"></a>    <span class="k">print</span><span class="p">(</span><span class="s2">"Ready for Sphinx."</span><span class="p">)</span>
<a name="listingsnibookpy-149"></a>
<a name="listingsnibookpy-150"></a>    <span class="n">QUESTIONS</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">"epub"</span><span class="p">,</span> <span class="s2">"Run Sphinx epub builder"</span><span class="p">),</span>
<a name="listingsnibookpy-151"></a>                <span class="p">(</span><span class="s2">"latex"</span><span class="p">,</span> <span class="s2">"Run Sphinx latex builder"</span><span class="p">),</span>
<a name="listingsnibookpy-152"></a>                <span class="p">(</span><span class="s2">"mobi"</span><span class="p">,</span> <span class="s2">"Run KindleGen"</span><span class="p">),</span>
<a name="listingsnibookpy-153"></a>                <span class="p">(</span><span class="s2">"copy"</span><span class="p">,</span> <span class="s2">"Copy files to download directory"</span><span class="p">),</span>
<a name="listingsnibookpy-154"></a>                <span class="p">(</span><span class="s2">"deploy"</span><span class="p">,</span> <span class="s2">"Deploy files to GitHub Page"</span><span class="p">),</span>
<a name="listingsnibookpy-155"></a>                <span class="p">]</span>
<a name="listingsnibookpy-156"></a>
<a name="listingsnibookpy-157"></a>    <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">QUESTIONS</span><span class="p">:</span>
<a name="listingsnibookpy-158"></a>        <span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
<a name="listingsnibookpy-159"></a>            <span class="k">print</span><span class="p">()</span>
<a name="listingsnibookpy-160"></a>            <span class="n">cmd</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">"{}? (Y/n) "</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<a name="listingsnibookpy-161"></a>            <span class="k">if</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">"n"</span><span class="p">:</span>
<a name="listingsnibookpy-162"></a>                <span class="k">break</span>
<a name="listingsnibookpy-163"></a>            <span class="k">elif</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">"y"</span> <span class="ow">or</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">"j"</span> <span class="ow">or</span> <span class="n">cmd</span> <span class="o">==</span> <span class="s2">""</span><span class="p">:</span>
<a name="listingsnibookpy-164"></a>                <span class="k">if</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"epub"</span><span class="p">:</span>
<a name="listingsnibookpy-165"></a>                    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">"make"</span><span class="p">,</span> <span class="s2">"clean"</span><span class="p">,</span> <span class="s2">"epub"</span><span class="p">])</span>
<a name="listingsnibookpy-166"></a>                <span class="k">elif</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"latex"</span><span class="p">:</span>
<a name="listingsnibookpy-167"></a>                    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">"make"</span><span class="p">,</span> <span class="s2">"latexpdf"</span><span class="p">])</span>
<a name="listingsnibookpy-168"></a>                <span class="k">elif</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"mobi"</span><span class="p">:</span>
<a name="listingsnibookpy-169"></a>                    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">"_build/epub"</span><span class="p">)</span>
<a name="listingsnibookpy-170"></a>                    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">"kindlegen"</span><span class="p">,</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">"*.epub"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]])</span>
<a name="listingsnibookpy-171"></a>                <span class="k">elif</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"copy"</span><span class="p">:</span>
<a name="listingsnibookpy-172"></a>                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">"*.epub"</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">GHP</span> <span class="o">+</span> <span class="n">DL_DIR</span><span class="p">)</span>
<a name="listingsnibookpy-173"></a>                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">"*.mobi"</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">GHP</span> <span class="o">+</span> <span class="n">DL_DIR</span><span class="p">)</span>
<a name="listingsnibookpy-174"></a>                    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">"../latex"</span><span class="p">)</span>
<a name="listingsnibookpy-175"></a>                    <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">"*.pdf"</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">GHP</span> <span class="o">+</span> <span class="n">DL_DIR</span><span class="p">)</span>
<a name="listingsnibookpy-176"></a>                <span class="k">elif</span> <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"deploy"</span><span class="p">:</span>
<a name="listingsnibookpy-177"></a>                    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">GHP</span><span class="p">)</span>
<a name="listingsnibookpy-178"></a>                    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">"nikola"</span><span class="p">,</span> <span class="s2">"build"</span><span class="p">])</span>
<a name="listingsnibookpy-179"></a>                    <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">"nikola"</span><span class="p">,</span> <span class="s2">"github_deploy"</span><span class="p">])</span> 
<a name="listingsnibookpy-180"></a>                <span class="k">break</span>
<a name="listingsnibookpy-181"></a>            <span class="k">else</span><span class="p">:</span>
<a name="listingsnibookpy-182"></a>                <span class="k">print</span><span class="p">(</span><span class="s2">"Invalid input. Try again..."</span><span class="p">)</span>
<a name="listingsnibookpy-183"></a>
<a name="listingsnibookpy-184"></a>    <span class="k">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">This is the end."</span><span class="p">)</span>
<a name="listingsnibookpy-185"></a>
<a name="listingsnibookpy-186"></a>
<a name="listingsnibookpy-187"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
<a name="listingsnibookpy-188"></a>
<a name="listingsnibookpy-189"></a>    <span class="n">collect_posts</span><span class="p">()</span>
<a name="listingsnibookpy-190"></a>    <span class="n">copy_posts</span><span class="p">()</span>
<a name="listingsnibookpy-191"></a>    <span class="n">create_index</span><span class="p">()</span>
<a name="listingsnibookpy-192"></a>    <span class="n">prepare_sources</span><span class="p">()</span>
<a name="listingsnibookpy-193"></a>    <span class="n">menu</span><span class="p">()</span>
</pre></td>
</tr></table>
<footer id="footer"><p>Contents Â© 2019 <a href="mailto:An.Ke@bahnfreikartoffelbrei.de">Anke (encarsia)</a> - 
Powered by <a href="http://getnikola.com">Nikola</a> - 
Zen theme based in <a href="https://github.com/arusahni/website-template">Arusahni's website-template</a><br></p>
            
        </footer>
</div>
    </section><script src="../assets/js/all-nocdn.js" type="text/javascript"></script><script type="text/javascript">
            $(function(){
                $('.timeago').timeago();
            });
        </script>
</body>
</html>
